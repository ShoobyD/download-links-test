<!DOCTYPE html>
<html>

	<head>

		<meta charset="utf-8">
		<title>download test</title>
		<meta name="viewport" content="width=device-width,initial-scale=1" />

		<link rel="stylesheet" href="css/main.css" />
		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,400" />
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

	</head>

	<body>

		<div id="wrapper">
			<header>
				<h1>download test</h1>
			</header>

			<div id="file-list">
				<h2>Files</h2>
			</div>
		</div>
		<script>

			const fileList = [
				'README.md',
				'somescript.js',
				'sad_dude.jpg',
				'bambi.jpg',
				'car.jpg',
			];
			const $filesUL = $( '<ul>' ).appendTo( '#file-list' );
			fileList.forEach( fname => $filesUL.append( `<li><a class="downloadLink" data-fname="${ fname }" href="files/${ fname }">${ fname }</a></li>` ) );

			let downloadPermissions;
			$( '.downloadLink' ).click( function( e ) {

				const $this = $( this );
				const fname = $this.data( 'fname' );
				const url   = $this.attr( 'href' );
				if ( downloadPermissions ) {
					if( downloadPermissions[ fname ] )
						downloadFile( fname, url );
				} else {
					$.getJSON( 'isDownload.json', function( data ) {
							downloadPermissions = data;
							if( downloadPermissions[ fname ] )
								downloadFile( fname, url );
						} )
						.fail( function( data ) {
							alert( "Bad JSON! Bad!" );
						} )
				}
				return false;

			} );

			const downloadAttrSupported = ( 'download' in document.createElement( 'a' ) );
			const downloadFile = downloadAttrSupported? function ( filename, url ) {
					const link = document.createElement( 'a' );
					link.download = 'dl_' + filename;
					link.href = url;
					link.click();
				}: function ( filename, url ) {
					$( '<iframe style="display:none;" src="https://shoobyd.pic-time.com/-test/download?mode=lowresphoto&photoId=371046869"></iframe>' )
						.on( 'load', function() {
							alert( 'iFrame loaded!' );
						} )
						.appendTo( 'body' );
				};

		</script>

	</body>

</html>

